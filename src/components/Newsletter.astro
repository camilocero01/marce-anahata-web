---
// Componente de Newsletter/Email Subscription
// Puede ser utilizado en diferentes páginas
export interface Props {
  title?: string;
  description?: string;
  compact?: boolean;
}

const {
  title = "Mantente actualizado sobre yoga, meditación y bienestar",
  description = "Recibe tips exclusivos, nuevos artículos del blog y primero enterarte de nuestros eventos especiales y promociones.",
  compact = false
} = Astro.props;
---

<div class={`newsletter-section ${compact ? 'compact' : 'full'}`}>
  <div class={`${compact ? 'max-w-2xl' : 'max-w-3xl'} mx-auto ${compact ? '' : 'text-center'}`}>
    <h3 class={`font-serif font-bold text-[#243c5a] mb-3 ${compact ? 'text-xl' : 'text-2xl md:text-3xl'}`}>
      {title}
    </h3>
    {!compact && (
      <p class="text-stone-600 mb-6 max-w-xl mx-auto">
        {description}
      </p>
    )}
    
    <form 
      id="newsletter-form"
      class="flex flex-col sm:flex-row gap-3 mb-4"
    >
      <input 
        type="email" 
        name="email"
        placeholder="tu@email.com"
        required
        class="flex-1 px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
        aria-label="Tu correo electrónico"
      />
      <button 
        type="submit"
        id="newsletter-btn"
        class="px-6 py-3 bg-[#6ed8d9] text-[#243c5a] rounded-lg font-semibold hover:bg-[#5ac5c6] transition-all shadow-md hover:shadow-lg whitespace-nowrap"
      >
        Suscribirse
      </button>
    </form>

    <div id="form-message" class="text-sm text-stone-500"></div>

    <p class="text-xs text-stone-400 mt-4">
      No compartimos tu email con nadie. Puedes desuscribirte en cualquier momento.
    </p>
  </div>
</div>

<style>
  .newsletter-section.compact {
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(110, 216, 217, 0.05) 0%, rgba(93, 90, 140, 0.05) 100%);
    border-radius: 0.75rem;
    border: 1px solid rgba(110, 216, 217, 0.2);
  }

  .newsletter-section.full {
    padding: 2rem;
    background: linear-gradient(to bottom, #f1f5f9, #ffffff);
    border-top: 2px solid #e2e8f0;
    border-bottom: 2px solid #e2e8f0;
  }
</style>

<script>
  // Handle newsletter form submission with AJAX (no redirect)
  const form = document.getElementById('newsletter-form');
  const messageDiv = document.getElementById('form-message');
  const submitBtn = document.getElementById('newsletter-btn');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const emailInput = form.querySelector('input[name="email"]') as HTMLInputElement;
      const email = emailInput.value;
      const originalText = submitBtn?.textContent || 'Suscribirse';

      // Show loading state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Suscribiendo...';
      }
      if (messageDiv) {
        messageDiv.textContent = '';
        messageDiv.className = 'text-sm text-stone-500';
      }

      try {
        // Create FormData object (Formspree prefers this over JSON)
        const formData = new FormData();
        formData.append('email', email);

        // Send to Formspree via AJAX (prevents redirect)
        const response = await fetch('https://formspree.io/f/mgovwznp', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          // Success - stay on the page
          if (messageDiv) {
            messageDiv.innerHTML = '✓ ¡Gracias por suscribirte! Hemos registrado tu correo electrónico, espera muy pronto .';
            messageDiv.className = 'text-sm text-green-600 font-semibold mt-2';
          }
          
          // Reset form
          form.reset();
          
          // Reset button after 5 seconds
          if (submitBtn) {
            setTimeout(() => {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
              if (messageDiv) {
                messageDiv.textContent = '';
                messageDiv.className = 'text-sm text-stone-500';
              }
            }, 5000);
          }
        } else {
          // Handle validation errors
          const errors = data.errors || [];
          const errorMessage = errors.length > 0 
            ? errors.map((err: any) => err.message).join(', ')
            : 'Error al procesar la suscripción';
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Newsletter error:', error);
        
        if (messageDiv) {
          messageDiv.innerHTML = '✗ Hubo un error. Por favor, verifica tu email e intenta de nuevo.';
          messageDiv.className = 'text-sm text-red-600 font-semibold mt-2';
        }
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }

        // Clear message after 5 seconds
        setTimeout(() => {
          if (messageDiv) {
            messageDiv.textContent = '';
            messageDiv.className = 'text-sm text-stone-500';
          }
        }, 5000);
      }
    });
  }
</script>
