---
// Componente de Formulario de Inscripci√≥n a Eventos
// Basado en Newsletter.astro con Formspree
export interface Props {
  eventTitle?: string;
  eventDate?: string;
  eventDescription?: string;
  formId?: string; // ID de Formspree del evento
  paymentLabel?: string; // Label para el campo de confirmaci√≥n de pago
}

const {
  eventTitle = "Inscripci√≥n al Evento",
  eventDate = "",
  eventDescription = "Completa el formulario para reservar tu lugar",
  formId = "mgovwznp", // Por defecto usa el mismo de newsletter, cambiar seg√∫n evento
  paymentLabel = "La inversi√≥n del evento ser√° de <strong>$120.000 COP</strong>. Entiendo que llenar este formulario es una pre-inscripci√≥n, mi cupo se reserva con el pago del 50% del total correspondinete a <strong>$60.000 COP</strong> a la cuenta de ahorros No. <strong>935-972725-35</strong> del Bancolombia a nombre de <strong>Marcela Zuleta cc 32297153</strong>. Una vez realizado el pago, enviar comprobante por <a href=\"https://wa.me/573207329921?text=Hola%20Marce%20Anahata%2C%20envio%20comprobante%20de%20pago%20para%20el%20Ba%C3%B1o%20de%20Gong%20del%2013%20de%20febrero%20de%202026.\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-[#6ed8d9] hover:text-[#5ac5c6] font-semibold underline\">üëâac√°</a> para confirmar. El valor restante debe ser pagado 2 d√≠as antes del evento."
} = Astro.props;
---

<div class="event-registration-section">
  <div class="max-w-2xl mx-auto">
    <h3 class="font-serif font-bold text-[#243c5a] mb-2 text-2xl md:text-3xl">
      {eventTitle}
    </h3>
    {eventDate && (
      <p class="text-sm text-[#6ed8d9] font-semibold mb-4">
        üìÖ {eventDate}
      </p>
    )}
    {eventDescription && (
      <p class="text-stone-600 mb-6">
        {eventDescription}
      </p>
    )}
    
    <form 
      id="event-registration-form"
      class="space-y-4 mb-6"
      aria-label="Formulario de inscripci√≥n al evento"
    >
      <!-- Nombre completo -->
      <div>
        <label for="full-name" class="block text-sm font-medium text-[#243c5a] mb-2">
          Nombre completo *
        </label>
        <input 
          type="text" 
          id="full-name"
          name="full_name"
          placeholder="Tu nombre"
          required
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
          aria-label="Nombre completo"
        />
      </div>

      <!-- Correo electr√≥nico -->
      <div>
        <label for="email" class="block text-sm font-medium text-[#243c5a] mb-2">
          Correo electr√≥nico *
        </label>
        <input 
          type="email" 
          id="email"
          name="email"
          placeholder="tu@email.com"
          required
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
          aria-label="Correo electr√≥nico"
        />
      </div>

      <!-- Ciudad y Pa√≠s -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="city" class="block text-sm font-medium text-[#243c5a] mb-2">
            Ciudad *
          </label>
          <input 
            type="text" 
            id="city"
            name="city"
            placeholder="Medell√≠n"
            required
            class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
            aria-label="Ciudad de residencia"
          />
        </div>
        <div>
          <label for="country" class="block text-sm font-medium text-[#243c5a] mb-2">
            Pa√≠s *
          </label>
          <input 
            type="text" 
            id="country"
            name="country"
            placeholder="Colombia"
            required
            class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
            aria-label="Pa√≠s de residencia"
          />
        </div>
      </div>

      <!-- Tel√©fono/WhatsApp -->
      <div>
        <label for="phone" class="block text-sm font-medium text-[#243c5a] mb-2">
          Tel√©fono/WhatsApp *
        </label>
        <input 
          type="tel" 
          id="phone"
          name="phone"
          placeholder="+57 300 123 4567"
          required
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors"
          aria-label="Tel√©fono o WhatsApp"
        />
      </div>
      <!-- ¬øC√≥mo te enteraste del evento? -->
      <div>
        <label for="source" class="block text-sm font-medium text-[#243c5a] mb-2">
          ¬øC√≥mo te enteraste del evento? *
        </label>
        <select 
          id="source"
          name="source"
          required
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors bg-white"
          aria-label="C√≥mo te enteraste del evento"
        >
          <option value="">-- Selecciona una opci√≥n --</option>
          <option value="instagram">Instagram</option>
          <option value="recomendacion">Recomendaci√≥n</option>
          <option value="marce-anahata">Directamente por Marce Anahata</option>
          <option value="buscadores">Buscador como google, bing, otros</option>
          <option value="otro">Otro</option>
        </select>
      </div>

      <!-- Separador: BIENESTAR Y CUIDADO -->
      <div class="pt-4 pb-2">
        <h4 class="font-serif font-semibold text-[#243c5a] text-lg border-b-2 border-[#6ed8d9]/30 pb-2">
          üíõ Bienestar y Cuidado
        </h4>
      </div>

      <!-- Primera vez en terapia de sonido -->
      <div>
        <label for="first-time" class="block text-sm font-medium text-[#243c5a] mb-2">
          ¬øHas participado antes en un ba√±o de gong o terapia de sonido? *
        </label>
        <select 
          id="first-time"
          name="first_time"
          required
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors bg-white"
          aria-label="Primera vez en terapia de sonido"
        >
          <option value="">-- Selecciona una opci√≥n --</option>
          <option value="no">S√≠, he participado antes</option>
          <option value="yes">No, es mi primera vez</option>
        </select>
      </div>

      <!-- Condiciones de salud -->
      <div>
        <label for="medical-conditions" class="block text-sm font-medium text-[#243c5a] mb-2">
          ¬øTienes alguna condici√≥n de salud que debamos tener en cuenta?
          <span class="text-stone-500 text-xs block mt-1">(Ej: embarazo, marcapasos, epilepsia, ansiedad severa, migra√±as, etc.) - Informaci√≥n confidencial</span>
        </label>
        <textarea 
          id="medical-conditions"
          name="medical_conditions"
          placeholder="Describe brevemente cualquier condici√≥n relevante..."
          rows="3"
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors resize-none"
          aria-label="Condiciones de salud"
        ></textarea>
      </div>

      <!-- Algo que compartir -->
      <div>
        <label for="share-info" class="block text-sm font-medium text-[#243c5a] mb-2">
          ¬øHay algo que quieras compartir para acompa√±arte mejor durante la sesi√≥n?
          <span class="text-stone-500 text-xs block mt-1">(Intenci√≥n, estado emocional, expectativas ‚Äì opcional)</span>
        </label>
        <textarea 
          id="share-info"
          name="share_info"
          placeholder="Comparte lo que sientas necesario..."
          rows="3"
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none placeholder:text-stone-400 transition-colors resize-none"
          aria-label="Informaci√≥n adicional"
        ></textarea>
      </div>

      <!-- ¬øQu√© te gustar√≠a trabajar? -->
      <div>
        <label for="intention" class="block text-sm font-medium text-[#243c5a] mb-2">
          ¬øQu√© te gustar√≠a trabajar o recibir en esta sesi√≥n?
          <span class="text-stone-500 text-xs"> (opcional)</span>
        </label>
        <select 
          id="intention"
          name="intention"
          class="w-full px-4 py-3 rounded-lg border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors bg-white"
        >
          <option value="">-- Selecciona una opci√≥n --</option>
          <option value="relajacion">Relajaci√≥n / Descanso</option>
          <option value="liberacion">Liberaci√≥n emocional</option>
          <option value="claridad">Claridad mental</option>
          <option value="equilibrio">Equilibrio energ√©tico</option>
          <option value="otro">Otro</option>
        </select>
      </div>

      <!-- Separador: CONSENTIMIENTO -->
      <div class="pt-4 pb-2">
        <h4 class="font-serif font-semibold text-[#243c5a] text-lg border-b-2 border-[#6ed8d9]/30 pb-2">
          ‚úì Consentimiento y Responsabilidad
        </h4>
      </div>

      <!-- Aviso sobre naturaleza complementaria -->
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded mb-4">
        <p class="text-sm text-blue-900 font-semibold mb-2">‚öïÔ∏è Importante: Naturaleza de esta experiencia</p>
        <p class="text-xs text-blue-800 leading-relaxed">
          El ba√±o de gong es una <strong>experiencia complementaria de bienestar y relajaci√≥n</strong>. No es un tratamiento m√©dico ni psicol√≥gico, y <strong>no reemplaza, sustituye ni puede usarse como alternativa a</strong> ning√∫n tratamiento m√©dico, psicol√≥gico, terap√©utico o farmacol√≥gico prescrito por profesionales de la salud. Si tienes una condici√≥n m√©dica diagnosticada, tomas medicamentos o est√°s bajo cuidado m√©dico, contin√∫a con tu tratamiento y consulta a tu profesional de salud antes de participar.
        </p>
      </div>

      <!-- Consentimiento 1 -->
      <div class="flex items-start gap-3">
        <input 
          type="checkbox" 
          id="consent-1"
          name="consent_voluntary"
          required
          class="mt-1 w-4 h-4 rounded border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors cursor-pointer"
        />
        <label for="consent-1" class="text-sm text-stone-700 cursor-pointer">
          Acepto participar de forma voluntaria y consciente en la sesi√≥n de ba√±o de gong. *
        </label>
      </div>

      <!-- Consentimiento 2 -->
      <div class="flex items-start gap-3">
        <input 
          type="checkbox" 
          id="consent-2"
          name="consent_complementary"
          required
          class="mt-1 w-4 h-4 rounded border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors cursor-pointer"
        />
        <label for="consent-2" class="text-sm text-stone-700 cursor-pointer">
          Comprendo que el ba√±o de gong es una <strong>experiencia complementaria</strong> de bienestar y que <strong>no reemplaza</strong> ning√∫n tratamiento m√©dico, psicol√≥gico, terap√©utico o farmacol√≥gico prescrito por profesionales de la salud. *
        </label>
      </div>

      <!-- Consentimiento 3 -->
      <div class="flex items-start gap-3">
        <input 
          type="checkbox" 
          id="consent-3"
          name="consent_responsibility"
          required
          class="mt-1 w-4 h-4 rounded border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors cursor-pointer"
        />
        <label for="consent-3" class="text-sm text-stone-700 cursor-pointer">
          Asumo la responsabilidad de mi salud. Si estoy bajo tratamiento m√©dico, psicol√≥gico o terap√©utico, continuar√© con √©l. Marce Anahata no es responsable de reacciones o efectos relacionados con mi participaci√≥n. *
        </label>
      </div>

      <!-- Confirmaci√≥n de cupo -->
      <div class="flex items-start gap-3 bg-amber-50 p-4 rounded-lg border border-amber-200">
        <input 
          type="checkbox" 
          id="payment-confirmation"
          name="payment_confirmation"
          required
          class="mt-1 w-4 h-4 rounded border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors cursor-pointer flex-shrink-0"
        />
        <label for="payment-confirmation" class="text-sm text-stone-700 cursor-pointer" set:html={paymentLabel + ' *'} />
      </div>

      <!-- Newsletter opt-in -->
      <div class="flex items-start gap-3 bg-[#6ed8d9]/5 p-4 rounded-lg border border-[#6ed8d9]/20">
        <input 
          type="checkbox" 
          id="newsletter"
          name="newsletter"
          class="mt-1 w-4 h-4 rounded border-2 border-stone-200 focus:border-[#6ed8d9] focus:outline-none transition-colors cursor-pointer"
        />
        <label for="newsletter" class="text-sm text-stone-700 cursor-pointer">
          Deseo recibir informaci√≥n de futuros eventos y sesiones de bienestar.
        </label>
      </div>

      <!-- Bot√≥n de env√≠o -->
      <button 
        type="submit"
        id="registration-btn"
        class="w-full px-6 py-3 bg-[#6ed8d9] text-[#243c5a] rounded-lg font-semibold hover:bg-[#5ac5c6] transition-all shadow-md hover:shadow-lg"
      >
        Reservar mi lugar
      </button>
    </form>

    <div id="form-message" class="text-sm text-stone-500" role="status" aria-live="polite"></div>

    <p class="text-xs text-stone-400 mt-4">
      Recibir√°s una confirmaci√≥n por email y WhatsApp con los detalles de asistencia.
    </p>
  </div>
</div>

<style>
  .event-registration-section {
    padding: 2.5rem 2rem;
    background: linear-gradient(135deg, rgba(110, 216, 217, 0.08) 0%, rgba(93, 90, 140, 0.05) 100%);
    border-radius: 1rem;
    border: 2px solid rgba(110, 216, 217, 0.2);
    margin: 2rem 0;
  }

  input[type="checkbox"] {
    cursor: pointer;
  }

  input[type="checkbox"]:checked {
    background-color: #6ed8d9;
    border-color: #6ed8d9;
  }
</style>

<script define:vars={{formId}}>
  // Handle event registration form submission
  const form = document.getElementById('event-registration-form');
  const messageDiv = document.getElementById('form-message');
  const submitBtn = document.getElementById('registration-btn');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const originalText = submitBtn?.textContent || 'Reservar mi lugar';

      // Show loading state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Reservando...';
      }
      if (messageDiv) {
        messageDiv.textContent = '';
        messageDiv.className = 'text-sm text-stone-500';
      }

      try {
        // Send to Formspree via AJAX
        const response = await fetch(`https://formspree.io/f/${formId}`, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          // Success - stay on the page
          if (messageDiv) {
            messageDiv.innerHTML = '‚úì ¬°Gracias por tu inscripci√≥n! Hemos recibido tu reserva. Pronto recibir√°s un correo de confirmaci√≥n con los detalles del evento. Nos vemos el 13 de febrero. üôè‚ú®';
            messageDiv.className = 'text-sm text-green-600 font-semibold mt-4 p-3 bg-green-50 rounded-lg';
          }
          
          // Reset form
          form.reset();
          
          // Reset button after 15 seconds
          if (submitBtn) {
            setTimeout(() => {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
              if (messageDiv) {
                messageDiv.textContent = '';
                messageDiv.className = 'text-sm text-stone-500';
              }
            }, 15000);
          }
        } else {
          // Handle validation errors
          const errors = data.errors || [];
          const errorMessage = errors.length > 0 
            ? errors.map((err) => err.message).join(', ')
            : 'Error al procesar la inscripci√≥n';
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Registration error:', error);
        
        if (messageDiv) {
          messageDiv.innerHTML = '‚úó Hubo un error. Por favor, verifica tus datos e intenta de nuevo, o escribe por WhatsApp a +57 320 7329921.';
          messageDiv.className = 'text-sm text-red-600 font-semibold mt-4 p-3 bg-red-50 rounded-lg';
        }
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }

        // Clear message after 15 seconds
        setTimeout(() => {
          if (messageDiv) {
            messageDiv.textContent = '';
            messageDiv.className = 'text-sm text-stone-500';
          }
        }, 15000);
      }
    });
  }
</script>
