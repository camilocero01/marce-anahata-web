---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data, slug }) => !data.draft && slug.startsWith('en/'));
  return posts.map((post) => {
    const slug = post.slug.replace(/^en\//, '');
    return {
      params: { slug },
      props: { post, lang: 'en' }
    };
  });
}

const { post, lang } = Astro.props;
const { data } = post;
const { Content } = await post.render();
const title = data.title;
const pageTitle = data.seoTitle || data.title;
const description = data.description;
const image = data.ogImage || data.image || '/images/social-preview.jpg';
const url = new URL(Astro.url);
const canonical = data.canonical || url.toString();
const publishedTime = new Date(data.pubDate).toISOString();
const modifiedTime = data.updatedDate ? new Date(data.updatedDate).toISOString() : undefined;

const breadcrumbItems = [
  { name: 'Home', url: 'https://marceanahata.com/en' },
  { name: 'Blog', url: 'https://marceanahata.com/en/blog' },
  { name: title, url: canonical }
];

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems.map((item, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: item.name,
    item: item.url
  }))
};

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  image: image,
  author: {
    '@type': 'Person',
    name: data.author || 'Marce Anahata'
  },
  datePublished: publishedTime,
  dateModified: modifiedTime || publishedTime,
  mainEntityOfPage: canonical,
  keywords: (data.tags || []).join(', '),
};

// Related posts: last 3 from same primary tag
const primaryTag = data.tags?.[0];
const relatedPosts = primaryTag
  ? (await getCollection('blog', ({ data: d, slug }) => !d.draft && slug.startsWith('en/') && (d.tags || []).includes(primaryTag)))
      .filter((p) => p.slug !== post.slug)
      .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
      .slice(0, 3)
  : [];
---
<Layout title={pageTitle} description={description} image={image} lang={lang}>
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    <meta property="article:published_time" content={publishedTime} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    <meta property="og:locale" content="en_US" />
    <meta property="og:image:alt" content={title} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />
    <meta name="twitter:image:alt" content={title} />
    <meta name="author" content={data.author || 'Marce Anahata'} />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>
  
  <main class="max-w-3xl mx-auto px-4 py-16">
    <a href="/en/blog" class="text-sm text-[#243c5a] hover:underline">← Back to blog</a>
    <article class="mt-6">
      <header class="mb-6">
        <h1 class="text-4xl font-serif text-[#243c5a] mb-2">{title}</h1>
        <p class="text-stone-600">{description}</p>
        <div class="mt-2 text-xs text-stone-500">
          <time datetime={publishedTime}>{new Date(data.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
          {data.tags?.length ? (
            <span>
              {' '}
              •{' '}
              {data.tags.map((t, i) => (
                <Fragment>
                  {i ? ' · ' : ''}
                  <a href={`/en/blog/tag/${encodeURIComponent(t)}`} class="text-[#243c5a] hover:text-[#6ed8d9]">#{t}</a>
                </Fragment>
              ))}
            </span>
          ) : null}
        </div>
      </header>

      {image && <img src={image} alt={title} width="1200" height="630" class="w-full h-64 object-cover rounded-xl mb-8" loading="eager" />}

      <div class="prose prose-stone max-w-none">
        <Content />
      </div>
    </article>

    {relatedPosts.length > 0 && (
      <section class="mt-16">
        <h2 class="text-2xl font-serif text-[#243c5a] mb-6">Related Articles</h2>
        <div class="grid gap-6 md:grid-cols-3">
          {relatedPosts.map((rp) => (
            <a href={`/en/blog/${rp.slug.replace(/^en\//, '')}`} class="block group" key={rp.slug}>
              <article class="border border-stone-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                <h3 class="text-lg font-semibold text-[#243c5a] group-hover:text-[#6ed8d9] transition-colors mb-2">{rp.data.title}</h3>
                <p class="text-sm text-stone-600 line-clamp-2">{rp.data.description}</p>
                <time class="text-xs text-stone-400 mt-2 block">{new Date(rp.data.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</time>
              </article>
            </a>
          ))}
        </div>
      </section>
    )}

    <div class="mt-12 p-6 bg-stone-100 rounded-xl">
      <p class="text-sm text-stone-700">
        <strong>Share this article:</strong>
        <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(canonical)}&text=${encodeURIComponent(title)}`} target="_blank" class="ml-4 text-[#243c5a] hover:underline">Twitter</a>
        <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(canonical)}`} target="_blank" class="ml-4 text-[#243c5a] hover:underline">Facebook</a>
        <a href={`https://wa.me/?text=${encodeURIComponent(title + ' ' + canonical)}`} target="_blank" class="ml-4 text-[#243c5a] hover:underline">WhatsApp</a>
      </p>
    </div>
  </main>
</Layout>
