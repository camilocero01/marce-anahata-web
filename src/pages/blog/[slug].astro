---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { data } = post;
const { Content } = await post.render();
const title = data.title;
const description = data.description;
const image = data.ogImage || data.image || '/images/social-preview.jpg';
const url = new URL(Astro.url);
const canonical = data.canonical || url.toString();
const publishedTime = new Date(data.pubDate).toISOString();
const modifiedTime = data.updatedDate ? new Date(data.updatedDate).toISOString() : undefined;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  image: image,
  author: {
    '@type': 'Person',
    name: data.author || 'Marce Anahata'
  },
  datePublished: publishedTime,
  dateModified: modifiedTime || publishedTime,
  mainEntityOfPage: canonical,
  keywords: (data.tags || []).join(', '),
};
---
<Layout title={title} description={description} image={image} ogType="article">
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    <meta property="article:published_time" content={publishedTime} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    <meta name="twitter:card" content="summary_large_image" />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>
  
  <main class="max-w-3xl mx-auto px-4 py-16">
    <a href="/blog" class="text-sm text-[#243c5a] hover:underline">← Volver al blog</a>
    <article class="mt-6">
      <header class="mb-6">
        <h1 class="text-4xl font-serif text-[#243c5a] mb-2">{title}</h1>
        <p class="text-stone-600">{description}</p>
        <div class="mt-2 text-xs text-stone-500">
          <time datetime={publishedTime}>{new Date(data.pubDate).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
          {data.tags?.length ? (
            <span> • {data.tags.map((t, i) => (i ? ' · #' + t : '#' + t))}</span>
          ) : null}
        </div>
      </header>

      {image && <img src={image} alt={title} class="w-full h-64 object-cover rounded-xl mb-8" loading="eager" />}

      <div class="article-content">
        <Content />
      </div>
    </article>
  </main>
</Layout>

<style>
  .article-content {
    color: #57534e;
    line-height: 1.75;
  }

  .article-content :global(h2) {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.875rem;
    font-weight: 600;
    color: #243c5a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .article-content :global(h3) {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #243c5a;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.5rem;
    font-size: 1rem;
    line-height: 1.75;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.5rem;
    margin-left: 1.5rem;
  }

  .article-content :global(ul) {
    list-style-type: disc;
  }

  .article-content :global(ol) {
    list-style-type: decimal;
  }

  .article-content :global(li) {
    line-height: 1.75;
    margin-bottom: 0.5rem;
  }

  .article-content :global(strong) {
    font-weight: 700;
    color: #243c5a;
  }

  .article-content :global(a) {
    color: #5d5a8c;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .article-content :global(a:hover) {
    color: #6ed8d9;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid #6ed8d9;
    padding-left: 1rem;
    font-style: italic;
    color: #78716c;
    margin: 1.5rem 0;
  }

  .article-content :global(code) {
    background-color: #f5f5f4;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: monospace;
    color: #243c5a;
  }

  .article-content :global(pre) {
    background-color: #f5f5f4;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .article-content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }
</style>
