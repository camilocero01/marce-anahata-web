---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { data } = post;
const { Content } = await post.render();
const title = data.title;
const pageTitle = data.seoTitle || data.title;
const description = data.description;
const image = data.ogImage || data.image || '/images/social-preview.jpg';
const url = new URL(Astro.url);
const canonical = data.canonical || url.toString();
const publishedTime = new Date(data.pubDate).toISOString();
const modifiedTime = data.updatedDate ? new Date(data.updatedDate).toISOString() : undefined;

const breadcrumbItems = [
  { name: 'Home', url: 'https://marceanahata.com' },
  { name: 'Blog', url: 'https://marceanahata.com/blog' },
  { name: title, url: canonical }
];

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems.map((item, index) => ({\n    '@type': 'ListItem',
    position: index + 1,
    name: item.name,
    item: item.url
  }))
};

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  image: image,
  author: {
    '@type': 'Person',
    name: data.author || 'Marce Anahata'
  },
  datePublished: publishedTime,
  dateModified: modifiedTime || publishedTime,
  mainEntityOfPage: canonical,
  keywords: (data.tags || []).join(', '),
};

// Related posts: last 3 from same primary tag
const primaryTag = data.tags?.[0];
const relatedPosts = primaryTag
  ? (await getCollection('blog', ({ data: d }) => !d.draft && (d.tags || []).includes(primaryTag)))
      .filter((p) => p.slug !== post.slug)
      .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
      .slice(0, 3)
  : [];
---
<Layout title={pageTitle} description={description} image={image} ogType="article" hideAuthorInTitle={true}>
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    <meta property="article:published_time" content={publishedTime} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    <meta property="og:locale" content="es_CO" />
    <meta property="og:image:alt" content={title} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />
    <meta name="twitter:image:alt" content={title} />
    <meta name="author" content={data.author || 'Marce Anahata'} />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>
  
  <main class="max-w-3xl mx-auto px-4 py-16">
    <a href="/blog" class="text-sm text-[#243c5a] hover:underline">← Volver al blog</a>
    <article class="mt-6">
      <header class="mb-6">
        <h1 class="text-4xl font-serif text-[#243c5a] mb-2">{title}</h1>
        <p class="text-stone-600">{description}</p>
        <div class="mt-2 text-xs text-stone-500">
          <time datetime={publishedTime}>{new Date(data.pubDate).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
            {data.tags?.length ? (
              <span>
                {' '}
                •{' '}
                {data.tags.map((t, i) => (
                  <Fragment>
                    {i ? ' · ' : ''}
                    <a href={`/blog/tag/${encodeURIComponent(t)}`} class="text-[#243c5a] hover:text-[#6ed8d9]">#{t}</a>
                  </Fragment>
                ))}
              </span>
            ) : null}
        </div>
      </header>

      {image && <img src={image} alt={title} class="w-full h-64 object-cover rounded-xl mb-8" loading="eager" />}

      <div class="article-content">
        <Content />
      </div>
    </article>

    {relatedPosts.length > 0 && (
      <section class="mt-16">
        <h2 class="text-2xl md:text-3xl font-serif text-[#243c5a] mb-6">También te podría interesar…</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {relatedPosts.map((rp) => (
            <article class="bg-stone-50 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 border border-stone-100 flex flex-col">
              {rp.data.image && (
                <div class="h-40 overflow-hidden">
                  <img
                    src={rp.data.image}
                    alt={rp.data.title}
                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-700"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-5 flex flex-col flex-grow">
                <time class="text-xs text-stone-500 mb-2 uppercase tracking-wider">
                  {new Date(rp.data.pubDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
                <h3 class="text-lg font-semibold text-[#243c5a] mb-2 leading-tight">
                  {rp.data.title}
                </h3>
                <p class="text-stone-600 text-sm mb-4 flex-grow leading-relaxed">
                  {rp.data.description}
                </p>
                <a href={`/blog/${rp.slug}`} class="text-[#243c5a] font-semibold text-sm hover:text-[#6ed8d9] transition-colors inline-flex items-center gap-1">
                  Leer más
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </article>
          ))}
        </div>
        <div class="text-center mt-10">
          <a
            href={`/blog/tag/${encodeURIComponent(primaryTag)}`}
            class="inline-block px-6 py-3 border-2 border-[#243c5a] text-[#243c5a] rounded-lg hover:bg-[#243c5a] hover:text-white transition-all font-semibold"
          >
            Ver más de {primaryTag}
          </a>
        </div>
      </section>
    )}
  </main>
</Layout>

<style>
  .article-content {
    color: #57534e;
    line-height: 1.75;
  }

  .article-content :global(h2) {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.875rem;
    font-weight: 600;
    color: #243c5a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .article-content :global(h3) {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #243c5a;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.5rem;
    font-size: 1rem;
    line-height: 1.75;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.5rem;
    margin-left: 1.5rem;
  }

  .article-content :global(ul) {
    list-style-type: disc;
  }

  .article-content :global(ol) {
    list-style-type: decimal;
  }

  .article-content :global(li) {
    line-height: 1.75;
    margin-bottom: 0.5rem;
  }

  .article-content :global(strong) {
    font-weight: 700;
    color: #243c5a;
  }

  .article-content :global(a) {
    color: #5d5a8c;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .article-content :global(a:hover) {
    color: #6ed8d9;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid #6ed8d9;
    padding-left: 1rem;
    font-style: italic;
    color: #78716c;
    margin: 1.5rem 0;
  }

  .article-content :global(code) {
    background-color: #f5f5f4;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: monospace;
    color: #243c5a;
  }

  .article-content :global(pre) {
    background-color: #f5f5f4;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .article-content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }
</style>
